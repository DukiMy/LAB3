package lab3;

import static java.lang.System.out;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;

import java.awt.Color;
import java.util.ArrayList;
import java.util.List;

import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Test;

import lab3.interfaces.TurboChargable;

class VehicleTest {
  private final List<GameObject> created = new ArrayList<>();

  private <T extends GameObject> T track(T obj) {
    created.add(obj);
    return obj;
  }

  @AfterEach
  void cleanup() {
    for (GameObject o : created) o.destroy();
    created.clear();
  }

  @Test
  void vehicleMovesForward() {
    double startX;
    double startY;
    Vehicle v;

    track(new Volvo240());
    track(new Saab95());
    track(new VolvoFH16());

    for (GameObject gObj : created) {
      startX = gObj.getX();
      startY = gObj.getY();

      v = (Vehicle) gObj;

      v.startEngine();
      v.gas(0.3);
      v.move();

      assertTrue(
        v.getX() != startX || v.getY() != startY,
        String.format(
          "%s flyttade inte när 'move()' anropades.",
          v.getModelName()
        )
      );
    }
  }

  @Test
  void turningChangesDirection() {
    double dirBeforeTurn;
    double dirAfterTurn;
    boolean hasLeftTurn;
    boolean hasRightTurn;
    Vehicle v;

    track(new Volvo240());
    track(new Saab95());
    track(new VolvoFH16());

    for (GameObject gObj : created) {
      v = (Vehicle) gObj;

      dirBeforeTurn = v.getDirection();
      v.turnLeft();
      dirAfterTurn = v.getDirection();
      hasLeftTurn = (dirBeforeTurn != dirAfterTurn);

      dirBeforeTurn = v.getDirection();
      v.turnRight();
      dirAfterTurn = v.getDirection();
      hasRightTurn = (dirBeforeTurn != dirAfterTurn);

      assertTrue(
        hasLeftTurn && hasRightTurn,
        String.format(
          "%s ändrade inte riktning.",
          v.getModelName()
        )
      );
    }
  }

  @Test
  void brakeReducesSpeed() {
    double speedBeforeBraking;
    double speedAfterBreaking;
    Vehicle v;

    track(new Volvo240());
    track(new Saab95());
    track(new VolvoFH16());
    track(new Scania());

    for (GameObject gObj : created) {
      v = (Vehicle) gObj;

      v.startEngine();
      v.gas(0.5);
      v.move();
      speedBeforeBraking = v.getCurrentSpeed();

      v.brake(0.5);
      speedAfterBreaking = v.getCurrentSpeed();

      assertTrue(
        speedAfterBreaking < speedBeforeBraking,
        String.format(
          "Farten sänktes inte när %s bromsade in.",
          v.getModelName()
        )
      );
    }
  }

  @Test
  void gasRejectsOutOfRange() {
    track(new Volvo240());
    track(new Saab95());
    track(new VolvoFH16());
    track(new Scania());

    for (GameObject gObj : created) {
      Vehicle v = (Vehicle) gObj;

      assertThrows(IllegalArgumentException.class, () -> v.gas(-0.0001));
      assertThrows(IllegalArgumentException.class, () -> v.gas( 1.0001));
    }
  }

  @Test
  void brakeRejectsOutOfRange() {
    track(new Volvo240());
    track(new Saab95());
    track(new VolvoFH16());
    track(new Scania());

    for (GameObject gObj : created) {
      Vehicle v = (Vehicle) gObj;

      assertThrows(IllegalArgumentException.class, () -> v.brake(-0.0001d));
      assertThrows(IllegalArgumentException.class, () -> v.brake( 1.0001d));
    }
  }

  @Test
  void turboIncreasesSpeed() {
    double speedIncrease = 0.3d;

    Vehicle v = track(new Saab95());
    double speedBefore;

    v.startEngine();
    v.gas(speedIncrease);
    speedBefore = v.getCurrentSpeed();
    v.stopEngine();

    TurboChargable turboV = (TurboChargable) v;
    turboV.setTurbo(true);

    double speedAfter;
    v = (Saab95)turboV;
    v.startEngine();
    v.gas(speedIncrease);
    speedAfter = v.getCurrentSpeed();
    v.stopEngine();

    assertTrue(
      speedBefore < speedAfter,
      "Turbon ökade inte farten."
    );
  }

  @Test
  void setCurrentSpeedBoundsWork() {
    Vehicle v;

    track(new Volvo240());
    track(new Saab95());
    track(new VolvoFH16());
    track(new Scania());

    for (GameObject gObj : created) {
      v = (Vehicle) gObj;

      v.startEngine();
      for (int i = 0; i < 150; i++) {
        v.gas(1.0d);
      }

      assertTrue(
        v.getCurrentSpeed() == v.getEnginePower(),
         "'setCurrentSpeed' håller inte övre fartgräns"
      );

      v.stopEngine();

      for (int i = 0; i < 100; i++) {
        v.brake(1.0d);
      }

      assertTrue(
        v.getCurrentSpeed() == 0.0d,
      "'setCurrentSpeed' håller inte nedre fartgräns"
      );
    }
  }

  @Test
  void toStringIsOverridden() throws NoSuchMethodException {
    Vehicle v;

    track(new Volvo240());
    track(new Saab95());
    track(new VolvoFH16());
    track(new Scania());

    for (GameObject gObj : created) {
      v = (Vehicle) gObj;
      String toString = v.toString();
      assertNotNull(toString);
      assertFalse(toString.isBlank());
      assertEquals(
        v.getClass(),
        v.getClass()
          .getMethod("toString")
          .getDeclaringClass()
      );

      out.println(v.toString());
    }
  }

  @Test
  void colorIsMutatedAndAccessed() {
    Vehicle v;
    Color c;

    track(new Volvo240());
    track(new Saab95());
    track(new VolvoFH16());
    track(new Scania());

    for (GameObject gObj : created) {
      v = (Vehicle) gObj;
      c = new Color(0);
      v.setColor(c.getRGB());

      assertTrue(
        v.getColor() == c.getRGB(),
        "Färg kunnde inte muteras eller hämtas"
      );
    }
  }

  @Test
  void vehicleHasDoors() {
    Vehicle v;

    track(new Volvo240());
    track(new Saab95());
    track(new VolvoFH16());
    track(new Scania());

    for (GameObject gObj : created) {
      v = (Vehicle) gObj;

      assertTrue(
        0 < v.getNrDoors(),
        "Vehicle " + v.getModelName() + " har inga dörrar."
      );
    }
  }
}
